#!/usr/bin/env bash
set -euo pipefail

CONFIG="${CONFIG:-/etc/andrzej-tools.conf}"
[[ -r "$CONFIG" ]] && # shellcheck disable=SC1090
source "$CONFIG"

: "${RECIPIENT:?missing RECIPIENT in $CONFIG}"
THROTTLE_SEC="${AUTH_THROTTLE_SEC:-600}"

STATE_DIR="/var/lib/andrzej-tools/auth-watch"
mkdir -p "$STATE_DIR"

send_mail() {
  local subject="$1" body="$2"
  {
    printf "Subject: %s\n" "$subject"
    printf "To: %s\n" "$RECIPIENT"
    printf "\n%s\n" "$body"
  } | msmtp -t
}

log() {
  # loguje do journala pod tagiem "auth-watch"
  logger -t auth-watch -- "$*"
}

should_send() {
  local key="$1"
  local now last f
  now="$(date +%s)"
  f="${STATE_DIR}/${key}.last"
  last="$(cat "$f" 2>/dev/null || echo 0)"
  if (( now - last >= THROTTLE_SEC )); then
    echo "$now" >"$f"
    return 0
  fi
  return 1
}

host="$(hostname -f 2>/dev/null || hostname)"

# U Ciebie realne logi lecą jako sshd-session; zostawiamy też sshd.
journalctl -f -o cat -t sshd -t sshd-session --no-pager |
while IFS= read -r line; do
  if [[ "$line" =~ Failed\ password\ for\ (invalid\ user\ )?([^[:space:]]+)\ from\ ([^[:space:]]+)\ port\ ([0-9]+)\ ssh2 ]]; then
    user="${BASH_REMATCH[2]}"
    ip="${BASH_REMATCH[3]}"
    port="${BASH_REMATCH[4]}"

    key="ssh_${ip}_${user}"

    if should_send "$key"; then
      ts="$(date -Is)"
      log "MATCH send user=$user ip=$ip port=$port"
      subj="[AUTH-FAIL][SSH] ${host}: ${user} from ${ip}"
      body="Time: ${ts}
Host: ${host}
Type: SSH bad password
User: ${user}
Source: ${ip}
Port: ${port}

Log line:
${line}"
      send_mail "$subj" "$body" || log "ERROR mail_send_failed user=$user ip=$ip"
    else
      log "MATCH throttled user=$user ip=$ip port=$port throttle=${THROTTLE_SEC}s"
    fi
  fi
done
